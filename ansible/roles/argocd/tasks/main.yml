---
- name: Install Helm binary
  ansible.builtin.shell: |
    curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
  args:
    creates: /usr/local/bin/helm
  delegate_to: localhost
  become: true

- name: Add ArgoCD Helm repo
  kubernetes.core.helm_repository:
    name: argo
    repo_url: "{{ argocd_chart_repo }}"
    kubeconfig: "{{ kubeconfig_path }}"
  delegate_to: localhost
  become: false

- name: Create ArgoCD namespace
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig_path }}"
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ argocd_namespace }}"
  delegate_to: localhost
  become: false

- name: Deploy ArgoCD via Helm
  kubernetes.core.helm:
    name: argocd
    chart_ref: argo/argo-cd
    chart_version: "{{ argocd_chart_version }}"
    release_namespace: "{{ argocd_namespace }}"
    create_namespace: true
    kubeconfig: "{{ kubeconfig_path }}"
    values: "{{ lookup('template', 'argocd-values.yml.j2') | from_yaml }}"
    wait: true
    wait_timeout: 300s
  delegate_to: localhost
  become: false

- name: Apply ArgoCD repo secret
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig_path }}"
    state: present
    definition: "{{ lookup('template', 'argocd-repo-secret.yml.j2') | from_yaml }}"
  delegate_to: localhost
  become: false

- name: Create Linkerd namespace
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig_path }}"
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ linkerd_namespace }}"
        labels:
          linkerd.io/is-control-plane: "true"
          config.linkerd.io/admission-webhooks: disabled
  delegate_to: localhost
  become: false

- name: Create Linkerd viz namespace
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig_path }}"
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ linkerd_viz_namespace }}"
        labels:
          linkerd.io/extension: viz
  delegate_to: localhost
  become: false

- name: Read Linkerd trust anchor cert
  ansible.builtin.slurp:
    src: "{{ playbook_dir }}/../{{ linkerd_trust_anchor_cert_path }}"
  register: linkerd_ca_crt
  delegate_to: localhost
  become: false

- name: Read Linkerd trust anchor key
  ansible.builtin.set_fact:
    linkerd_ca_key_content: "{{ lookup('file', playbook_dir + '/../' + linkerd_trust_anchor_key_path) }}"
  delegate_to: localhost
  become: false

- name: Apply Linkerd trust anchor secret
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig_path }}"
    state: present
    definition: "{{ lookup('template', 'linkerd-trust-anchor-secret.yml.j2') | from_yaml }}"
  delegate_to: localhost
  become: false

- name: Read Linkerd issuer cert
  ansible.builtin.slurp:
    src: "{{ playbook_dir }}/../{{ linkerd_issuer_cert_path }}"
  register: linkerd_issuer_crt
  delegate_to: localhost
  become: false

- name: Read Linkerd issuer key
  ansible.builtin.set_fact:
    linkerd_issuer_key_content: "{{ lookup('file', playbook_dir + '/../' + linkerd_issuer_key_path) }}"
  delegate_to: localhost
  become: false

- name: Apply Linkerd identity issuer secret
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig_path }}"
    state: present
    definition: "{{ lookup('template', 'linkerd-identity-issuer-secret.yml.j2') | from_yaml }}"
  delegate_to: localhost
  become: false

- name: Apply infrastructure AppProject
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig_path }}"
    state: present
    src: "{{ playbook_dir }}/../../kubernetes/projects/infrastructure.yml"
  delegate_to: localhost
  become: false

- name: Apply applications AppProject
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig_path }}"
    state: present
    src: "{{ playbook_dir }}/../../kubernetes/projects/applications.yml"
  delegate_to: localhost
  become: false

- name: Apply root Application
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig_path }}"
    state: present
    src: "{{ playbook_dir }}/../../kubernetes/root-app.yml"
  delegate_to: localhost
  become: false

- name: Get ArgoCD initial admin password
  kubernetes.core.k8s_info:
    kubeconfig: "{{ kubeconfig_path }}"
    kind: Secret
    name: argocd-initial-admin-secret
    namespace: "{{ argocd_namespace }}"
  register: argocd_admin_secret
  delegate_to: localhost
  become: false

- name: Display ArgoCD admin password
  ansible.builtin.debug:
    msg: "ArgoCD admin password: {{ argocd_admin_secret.resources[0].data.password | b64decode }}"
  when: argocd_admin_secret.resources | length > 0
