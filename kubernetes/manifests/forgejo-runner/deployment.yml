---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: forgejo-runner
  namespace: forgejo
  labels:
    app: forgejo-runner
spec:
  replicas: 1
  selector:
    matchLabels:
      app: forgejo-runner
  template:
    metadata:
      labels:
        app: forgejo-runner
    spec:
      containers:
        - name: runner
          image: code.forgejo.org/forgejo/runner:6.3.1
          command:
            - sh
            - -c
            - |
              while ! nc -z localhost 2376; do
                echo "Waiting for DinD to be ready..."
                sleep 2
              done
              forgejo-runner create-runner-file --instance http://forgejo-http.forgejo.svc.cluster.local:3000 --secret $(cat /secret/token)
              forgejo-runner daemon --config /config/config.yml
          env:
            - name: DOCKER_HOST
              value: tcp://localhost:2376
            - name: DOCKER_TLS_VERIFY
              value: "1"
            - name: DOCKER_CERT_PATH
              value: /certs/client
          volumeMounts:
            - name: docker-certs
              mountPath: /certs
              readOnly: true
            - name: runner-config
              mountPath: /config
              readOnly: true
            - name: runner-data
              mountPath: /data
            - name: runner-secret
              mountPath: /secret
              readOnly: true
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 256Mi

        - name: dind
          image: docker:27-dind
          securityContext:
            privileged: true
          args:
            - --insecure-registry=registry.home.lab
          env:
            - name: DOCKER_TLS_CERTDIR
              value: /certs
          volumeMounts:
            - name: docker-certs
              mountPath: /certs
            - name: home-lab-ca
              mountPath: /usr/local/share/ca-certificates/home-lab-root-ca.crt
              subPath: home-lab-root-ca.crt
              readOnly: true
          lifecycle:
            postStart:
              exec:
                command:
                  - sh
                  - -c
                  - update-ca-certificates || true
          resources:
            requests:
              cpu: 200m
              memory: 512Mi
            limits:
              cpu: "2"
              memory: 4Gi

      volumes:
        - name: docker-certs
          emptyDir: {}
        - name: runner-config
          configMap:
            name: forgejo-runner-config
        - name: runner-data
          emptyDir: {}
        - name: runner-secret
          secret:
            secretName: forgejo-runner-secret
        - name: home-lab-ca
          configMap:
            name: forgejo-runner-ca
