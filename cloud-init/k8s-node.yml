#cloud-config
# Kubernetes node prerequisites â€” containerd, kernel modules, sysctl

package_update: true
package_upgrade: true
packages:
  - qemu-guest-agent
  - curl
  - wget
  - vim
  - htop
  - net-tools
  - sudo
  - ca-certificates
  - gnupg
  - lsb-release
  - containerd
  - apparmor
  - open-iscsi
  - nfs-common

users:
  - name: deploy
    groups: sudo
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    ssh_authorized_keys:
      - ssh-ed25519 CHANGEME_YOUR_PUBLIC_KEY deploy@homelab

write_files:
  - path: /etc/modules-load.d/k8s.conf
    content: |
      overlay
      br_netfilter
  - path: /etc/sysctl.d/k8s.conf
    content: |
      net.bridge.bridge-nf-call-iptables  = 1
      net.bridge.bridge-nf-call-ip6tables = 1
      net.ipv4.ip_forward                 = 1

runcmd:
  - systemctl enable --now qemu-guest-agent
  - modprobe overlay
  - modprobe br_netfilter
  - sysctl --system
  - systemctl enable --now containerd
  - swapoff -a
  - sed -i '/ swap / s/^/#/' /etc/fstab

power_state:
  mode: reboot
  condition: true
